<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一級建築士試験 学習管理</title>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#f5f5f5}
        h1,h2{color:#2196F3;margin-top:0}
        .box{background:white;padding:15px;margin-bottom:15px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .task{padding:8px;margin-bottom:5px;border-left:3px solid #2196F3;background:#f9f9f9;display:flex;justify-content:space-between;align-items:center}
        .task.done{opacity:.6;text-decoration:line-through}
        .btns{display:flex;gap:5px}
        button{background:#2196F3;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer}
        .del{background:#757575}
        select,input{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd}
        .tabs{display:flex;margin-bottom:10px}
        .tab{padding:8px 12px;cursor:pointer;background:#f1f1f1;border-right:1px solid #ddd}
        .tab.active{background:#2196F3;color:white}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .category{display:inline-block;padding:2px 5px;font-size:12px;border-radius:3px;color:white;margin-right:5px}
        .cat-planning{background:#2196F3}.cat-environment{background:#00BCD4}.cat-law{background:#9C27B0}
        .cat-structure{background:#FFC107}.cat-construction{background:#FF9800}.cat-other{background:#607D8B}
        #note{position:fixed;top:20px;right:20px;padding:10px;background:#4CAF50;color:white;border-radius:4px;display:none;z-index:100}
        .next{color:#E91E63;font-weight:bold}
        .ok{color:#4CAF50;font-weight:bold}
    </style>
</head>
<body>
    <div id="note"></div>
    <h1>一級建築士試験 学習管理</h1>
    
    <div class="box">
        <h2>今日の学習タスク</h2>
        <div id="tasks"></div>
        <button style="width:100%;margin-top:10px" onclick="addTask()">+ 新しいタスク</button>
    </div>
    
    <div class="box">
        <h2>学習記録</h2>
        <input type="date" id="date">
        <select id="cat" onchange="updateItems()">
            <option value="planning">計画</option>
            <option value="environment">環境・設備</option>
            <option value="law">法規</option>
            <option value="structure">構造</option>
            <option value="construction">施工</option>
            <option value="other">その他</option>
        </select>
        <div id="item-sel">
            <select id="item"></select>
        </div>
        <div id="other-item" style="display:none">
            <input type="text" id="other" placeholder="例：過去問演習（計画）">
        </div>
        <button style="width:100%" onclick="record()">記録する</button>
    </div>
    
    <div class="box">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('t1')">学習履歴</div>
            <div class="tab" onclick="switchTab('t2')">設定</div>
        </div>
        
        <div id="t1" class="tab-content active">
            <table>
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>項目</th>
                        <th>次回</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="hist"></tbody>
            </table>
        </div>
        
        <div id="t2" class="tab-content">
            <label for="exam">試験日</label>
            <input type="date" id="exam" value="2025-07-27">
            
            <label for="pattern">復習間隔（日数）</label>
            <input type="text" id="pattern" placeholder="例: 2, 7, 16, 35, 62">
            
            <button style="width:100%;margin-top:10px" onclick="saveSet()">設定保存</button>
            <div style="margin-top:20px">
                <button onclick="exp()">データ保存</button>
                <button onclick="imp()">データ読込</button>
                <button class="del" onclick="clear()">データ削除</button>
            </div>
        </div>
    </div>
    
    <script>
        // 学習項目データ - 計画/環境/法規は省略
        const items = {
            structure: [
                {id:'s1',name:'許容応力度'},{id:'s2',name:'風圧力・地震力'},{id:'s3',name:'木造・軸組の設置'},
                {id:'s4',name:'木造建築物（その他）'},{id:'s5',name:'鉄筋コンクリート（一般）'},
                {id:'s6',name:'鉄筋コンクリート（配筋・定着）'},{id:'s7',name:'鉄筋コンクリート（耐震）'},
                {id:'s8',name:'鉄骨構造（一般）'},{id:'s9',name:'鉄骨構造（接合）'},
                {id:'s10',name:'鉄骨鉄筋コンクリート構造'},{id:'s11',name:'建築構造'},{id:'s12',name:'土質・地盤'},
                {id:'s13',name:'基礎'},{id:'s14',name:'耐震設計'},{id:'s15',name:'構造計画'},{id:'s16',name:'木材'},
                {id:'s17',name:'コンクリート'},{id:'s18',name:'金属材料'}
            ],
            construction: [
                {id:'c1',name:'施工計画'},{id:'c2',name:'工事現場の管理等'},{id:'c3',name:'材料管理'},
                {id:'c4',name:'届出'},{id:'c5',name:'地盤調査'},{id:'c6',name:'仮設工事'},
                {id:'c7',name:'土工事・山留め工事'},{id:'c8',name:'杭地業工事'},{id:'c9',name:'鉄筋工事'},
                {id:'c10',name:'型枠工事'},{id:'c11',name:'コンクリート工事'},
                {id:'c12',name:'プレキャスト鉄筋コンクリート工事'},{id:'c13',name:'鉄骨工事'},
                {id:'c14',name:'木造軸組工法'},{id:'c15',name:'防水工事'},{id:'c16',name:'ガラス工事'},
                {id:'c17',name:'内装工事'},{id:'c18',name:'外装工事設備・各種工事'},{id:'c19',name:'耐震改修工事'},
                {id:'c20',name:'改修工事'},{id:'c21',name:'用語とその説明'},{id:'c22',name:'請負契約'}
            ],
            planning:[],environment:[],law:[],other:[]
        };
        
        let data = {tasks:[],history:[],studyRecords:{},settings:{examDate:'2025-07-27',pattern:[2,7,16,35,62]}};
        
        window.onload = function() {
            load();
            document.getElementById('date').valueAsDate = new Date();
            updateItems();
            renderTasks();
            renderHistory();
            document.getElementById('exam').value = data.settings.examDate;
            document.getElementById('pattern').value = data.settings.pattern.join(', ');
        };
        
        function load() {
            const saved = localStorage.getItem('architect_data');
            if (saved) {
                data = JSON.parse(saved);
                if (!data.settings) data.settings = {examDate:'2025-07-27',pattern:[2,7,16,35,62]};
                if (!data.settings.pattern) data.settings.pattern = [2,7,16,35,62];
                if (!data.studyRecords) data.studyRecords = {};
            }
        }
        
        function save() {
            localStorage.setItem('architect_data', JSON.stringify(data));
            notify('保存しました');
        }
        
        function notify(msg) {
            const note = document.getElementById('note');
            note.textContent = msg;
            note.style.display = 'block';
            setTimeout(() => {note.style.display = 'none';}, 2000);
        }
        
        function renderTasks() {
            const cont = document.getElementById('tasks');
            cont.innerHTML = '';
            
            if (data.tasks.length === 0) {
                cont.innerHTML = '<div style="padding:8px;color:#777">タスクがありません</div>';
                return;
            }
            
            data.tasks.forEach((task, i) => {
                const el = document.createElement('div');
                el.className = 'task' + (task.done ? ' done' : '');
                el.innerHTML = `
                    <div>
                        <span class="category cat-${task.cat}">${getLabel(task.cat)}</span>
                        ${task.name}
                    </div>
                    <div class="btns">
                        <button onclick="toggle(${i})">${task.done ? '戻す' : '完了'}</button>
                        <button class="del" onclick="delTask(${i})">削除</button>
                    </div>
                `;
                cont.appendChild(el);
            });
        }
        
        function delTask(i) {
            if (confirm('このタスクを削除しますか？')) {
                data.tasks.splice(i, 1);
                renderTasks();
                save();
            }
        }
        
        function renderHistory() {
            const table = document.getElementById('hist');
            table.innerHTML = '';
            
            if (data.history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align:center;color:#777">履歴なし</td>';
                table.appendChild(row);
                return;
            }
            
            const sorted = [...data.history].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach((rec, i) => {
                const row = document.createElement('tr');
                const date = new Date(rec.date);
                const fmtDate = `${date.getMonth()+1}/${date.getDate()}`;
                
                let nextText = '-';
                
                if (rec.done) {
                    nextText = '<span class="ok">完了</span>';
                } else if (rec.next) {
                    const nextDate = new Date(rec.next);
                    nextText = `${nextDate.getMonth()+1}/${nextDate.getDate()}`;
                    
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    if (nextDate < today) {
                        nextText = `<span class="next">期限切れ (${nextText})</span>`;
                    } else if (
                        nextDate.getDate() === today.getDate() && 
                        nextDate.getMonth() === today.getMonth() && 
                        nextDate.getFullYear() === today.getFullYear()
                    ) {
                        nextText = `<span class="next">今日 (${nextText})</span>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${fmtDate}</td>
                    <td><span class="category cat-${rec.cat}">${getLabel(rec.cat)}</span> ${rec.item}</td>
                    <td>${nextText}</td>
                    <td><button class="del" onclick="delHist(${i})">削除</button></td>
                `;
                table.appendChild(row);
            });
        }
        
        function delHist(i) {
            if (confirm('この記録を削除しますか？')) {
                const sorted = [...data.history].sort((a, b) => new Date(b.date) - new Date(a.date));
                const toDel = sorted[i];
                const idx = data.history.findIndex(r => 
                    r.date === toDel.date && r.item === toDel.item && r.cat === toDel.cat
                );
                
                if (idx !== -1) {
                    data.history.splice(idx, 1);
                    renderHistory();
                    save();
                }
            }
        }
        
        function updateItems() {
            const cat = document.getElementById('cat').value;
            const sel = document.getElementById('item');
            const itemSel = document.getElementById('item-sel');
            const other = document.getElementById('other-item');
            
            if (cat === 'other') {
                itemSel.style.display = 'none';
                other.style.display = 'block';
            } else {
                itemSel.style.display = 'block';
                other.style.display = 'none';
                sel.innerHTML = '';
                
                // サンプルデータを設定（本来は完全なデータを使用）
                const catItems = cat === 'structure' ? items.structure : 
                                 cat === 'construction' ? items.construction : 
                                 [{id:'1',name:'項目1'},{id:'2',name:'項目2'},{id:'3',name:'項目3'}];
                
                catItems.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    sel.appendChild(opt);
                });
            }
        }
        
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
        }
        
        function toggle(i) {
            data.tasks[i].done = !data.tasks[i].done;
            renderTasks();
            save();
        }
        
        function addTask() {
            const name = prompt('タスク名:');
            if (!name) return;
            
            const cats = ['planning', 'environment', 'law', 'structure', 'construction', 'other'];
            const def = 'planning';
            
            let prompt = '以下からカテゴリを選択（番号入力）:\n';
            cats.forEach((c, i) => prompt += `${i+1}: ${getLabel(c)}\n`);
            
            const input = prompt(prompt, '1');
            let cat = def;
            
            if (input && !isNaN(parseInt(input))) {
                const i = parseInt(input) - 1;
                if (i >= 0 && i < cats.length) cat = cats[i];
            }
            
            data.tasks.push({name, cat, done: false});
            renderTasks();
            save();
        }
        
        function getLabel(cat) {
            return {
                'planning': '計画',
                'environment': '環境',
                'law': '法規',
                'structure': '構造',
                'construction': '施工',
                'other': 'その他'
            }[cat] || '計画';
        }
        
        function nextDate(date, key, complete = false) {
            if (complete) return null;
            
            const d = new Date(date);
            const pattern = data.settings.pattern;
            const count = data.studyRecords[key] || 0;
            const idx = Math.min(count, pattern.length - 1);
            
            d.setDate(d.getDate() + pattern[idx]);
            return d;
        }
        
        function itemKey(cat, id, name) {
            return cat + ":" + (id || name);
        }
        
        function record() {
            const date = document.getElementById('date').value;
            if (!date) {
                alert('日付を選択してください');
                return;
            }
            
            const cat = document.getElementById('cat').value;
            let id = '';
            let item = '';
            
            if (cat === 'other') {
                item = document.getElementById('other').value;
                if (!item) {
                    alert('項目名を入力してください');
                    return;
                }
            } else {
                const sel = document.getElementById('item');
                id = sel.value;
                item = sel.options[sel.selectedIndex].text;
            }
            
            const key = itemKey(cat, id, item);
            
            data.history.forEach(r => {
                const rKey = itemKey(r.cat, r.id, r.item);
                if (rKey === key && r.next && !r.done) r.done = true;
            });
            
            if (!data.studyRecords[key]) data.studyRecords[key] = 0;
            data.studyRecords[key]++;
            
            const count = data.studyRecords[key];
            const complete = count >= data.settings.pattern.length;
            const next = nextDate(date, key, complete);
            
            data.history.push({
                date,
                cat,
                id,
                item,
                count,
                next: next ? next.toISOString() : null,
                done: complete
            });
            
            renderHistory();
            save();
            
            if (cat === 'other') document.getElementById('other').value = '';
        }
        
        function saveSet() {
            data.settings.examDate = document.getElementById('exam').value;
            
            const input = document.getElementById('pattern').value;
            if (input) {
                try {
                    const pattern = input.split(',').map(s => parseInt(s.trim()));
                    if (pattern.length > 0 && !pattern.some(isNaN)) {
                        data.settings.pattern = pattern;
                    }
                } catch (e) {
                    console.error('Invalid pattern:', e);
                }
            }
            
            save();
        }
        
        function exp() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const a = document.createElement('a');
            a.setAttribute("href", str);
            a.setAttribute("download", "architect_data.json");
            document.body.appendChild(a);
            a.click();
            a.remove();
        }
        
        function imp() {
            if (confirm('データを上書きします。よろしいですか？')) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const imported = JSON.parse(event.target.result);
                            data = imported;
                            if (!data.studyRecords) data.studyRecords = {};
                            save();
                            location.reload();
                        } catch (error) {
                            alert('読込エラー: ' + error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }
        
        function clear() {
            if (confirm('全データを削除します。この操作は元に戻せません。')) {
                localStorage.removeItem('architect_data');
                data = {
                    tasks: [],
                    history: [],
                    studyRecords: {},
                    settings: {examDate: '2025-07-27', pattern: [2, 7, 16, 35, 62]}
                };
                renderTasks();
                renderHistory();
                notify('削除しました');
            }
        }
    </script>
</body>
</html>
