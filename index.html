<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一級建築士試験 学習管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
        }
        h1, h2 { color: #2196F3; margin-top: 0; }
        .box {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .task {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #2196F3;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
        }
        .task.done {
            opacity: 0.6;
            text-decoration: line-through;
        }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-small {
            font-size: 0.8rem;
            padding: 2px 5px;
        }
        .btn-delete {
            background-color: #f44336;
        }
        select, input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f1f1f1;
            border-right: 1px solid #ddd;
        }
        .tab.active {
            background-color: #2196F3;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .category {
            display: inline-block;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
            color: white;
            margin-right: 5px;
        }
        .cat-planning { background-color: #2196F3; }
        .cat-environment { background-color: #00BCD4; }
        .cat-law { background-color: #9C27B0; }
        .cat-structure { background-color: #FFC107; }
        .cat-construction { background-color: #FF9800; }
        .cat-other { background-color: #607D8B; }
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: none;
        }
        .next-review {
            color: #E91E63;
            font-weight: bold;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="notification"></div>
    <h1>一級建築士試験 学習管理</h1>
    
    <!-- 今日の学習タスク -->
    <div class="box">
        <h2>今日の学習タスク</h2>
        <div id="tasks"></div>
        <button style="width: 100%; margin-top: 10px;" onclick="addTask()">+ 新しいタスク</button>
    </div>
    
    <!-- 学習記録フォーム -->
    <div class="box">
        <h2>学習記録</h2>
        <input type="date" id="study-date">
        <select id="study-category" onchange="updateItems()">
            <option value="planning">計画</option>
            <option value="environment">環境・設備</option>
            <option value="law">法規</option>
            <option value="structure">構造</option>
            <option value="construction">施工</option>
            <option value="other">その他</option>
        </select>
        <div id="item-selection">
            <select id="study-item"></select>
        </div>
        <div id="other-item" style="display: none;">
            <input type="text" id="other-item-input" placeholder="例：過去問演習（計画）">
        </div>
        <button style="width: 100%;" onclick="recordStudy()">記録する</button>
    </div>
    
    <!-- タブ付きコンテンツ -->
    <div class="box">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tab1')">学習履歴</div>
            <div class="tab" onclick="switchTab('tab2')">設定</div>
        </div>
        
        <!-- 学習履歴 -->
        <div id="tab1" class="tab-content active">
            <table>
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>項目</th>
                        <th>次回学習</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="history-tbody"></tbody>
            </table>
        </div>
        
        <!-- 設定 -->
        <div id="tab2" class="tab-content">
            <label for="exam-date">試験日</label>
            <input type="date" id="exam-date" value="2025-07-27">
            
            <label for="review-pattern">復習間隔（日数）</label>
            <input type="text" id="review-pattern" placeholder="例: 2, 7, 16, 35, 62">
            
            <button style="width: 100%; margin-top: 10px;" onclick="saveSettings()">設定保存</button>
            <div style="margin-top: 20px;">
                <button onclick="exportData()">データ保存</button>
                <button onclick="importData()">データ読込</button>
                <button onclick="clearData()" style="background-color: #f44336;">データ削除</button>
            </div>
        </div>
    </div>
    
    <script>
        // 学習項目データ
        const studyItems = {
            planning: [
                { id: 'p1', name: '建築設計の手法等' },
                { id: 'p2', name: '建築史' },
                { id: 'p3', name: '周辺環境・まちづくり' },
                { id: 'p4', name: '開口部' },
                { id: 'p5', name: '各部の寸法' },
                { id: 'p6', name: '高齢者・車いす使用者' },
                { id: 'p7', name: '集合住宅・住宅' },
                { id: 'p8', name: '事務所・商業建築' },
                { id: 'p9', name: '公共建築' },
                { id: 'p10', name: '高齢者の医療・福祉' },
                { id: 'p11', name: '建築計画' },
                { id: 'p12', name: '設計・工事監理・契約' },
                { id: 'p13', name: '積算' },
                { id: 'p14', name: 'プロジェクトマネジメント' }
            ],
            environment: [
                { id: 'e1', name: '環境工学・用語' },
                { id: 'e2', name: '室内環境・換気' },
                { id: 'e3', name: '伝熱・結露' },
                { id: 'e4', name: '日照・日射' },
                { id: 'e5', name: '昼光・照明' },
                { id: 'e6', name: '音響' },
                { id: 'e7', name: '色彩' },
                { id: 'e8', name: '空気調和設備' },
                { id: 'e9', name: '給排水設備' },
                { id: 'e10', name: '照明設備' },
                { id: 'e11', name: '電気設備' },
                { id: 'e12', name: '消火・防災設備' },
                { id: 'e13', name: '建築設備' },
                { id: 'e14', name: '環境・省エネ' }
            ],
            law: [
                { id: 'l1', name: '建築基準法（単体規定）' },
                { id: 'l2', name: '建築基準法（集団規定）' },
                { id: 'l3', name: '都市計画法' },
                { id: 'l4', name: '消防法' },
                { id: 'l5', name: '建築士法' }
            ],
            structure: [
                { id: 's1', name: '許容応力度' },
                { id: 's2', name: '風圧力・地震力' },
                { id: 's3', name: '木造・軸組の設置' },
                { id: 's4', name: '木造建築物（その他）' }
            ],
            construction: [
                { id: 'c1', name: '施工計画' },
                { id: 'c2', name: '工事現場の管理等' },
                { id: 'c3', name: '材料管理' },
                { id: 'c4', name: '届出' }
            ],
            other: []
        };
        
        // データモデル
        let appData = {
            tasks: [],
            history: [],
            settings: { 
                examDate: '2025-07-27',
                reviewPattern: [2, 7, 16, 35, 62]
            }
        };
        
        // 初期化
        window.onload = function() {
            loadData();
            document.getElementById('study-date').valueAsDate = new Date();
            updateItems();
            renderTasks();
            renderHistory();
            document.getElementById('exam-date').value = appData.settings.examDate;
            document.getElementById('review-pattern').value = appData.settings.reviewPattern.join(', ');
        };
        
        // データ読み込み
        function loadData() {
            const data = localStorage.getItem('architect_study_data');
            if (data) {
                appData = JSON.parse(data);
                // 設定値が存在しない場合はデフォルト値を設定
                if (!appData.settings) {
                    appData.settings = { examDate: '2025-07-27', reviewPattern: [2, 7, 16, 35, 62] };
                }
                if (!appData.settings.reviewPattern) {
                    appData.settings.reviewPattern = [2, 7, 16, 35, 62];
                }
            }
        }
        
        // データ保存
        function saveData() {
            localStorage.setItem('architect_study_data', JSON.stringify(appData));
            showNotification('データを保存しました');
        }
        
        // 通知表示
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, 2000);
        }
        
        // タスク表示
        function renderTasks() {
            const tasksContainer = document.getElementById('tasks');
            tasksContainer.innerHTML = '';
            
            if (appData.tasks.length === 0) {
                tasksContainer.innerHTML = '<div style="padding: 8px; color: #777;">タスクがありません</div>';
                return;
            }
            
            appData.tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task' + (task.completed ? ' done' : '');
                taskElement.innerHTML = `
                    <div>
                        <span class="category cat-${task.category}">${getCategoryLabel(task.category)}</span>
                        ${task.name}
                    </div>
                    <button onclick="toggleTask(${index})">${task.completed ? '戻す' : '完了'}</button>
                `;
                tasksContainer.appendChild(taskElement);
            });
        }
        
        // 履歴表示
        function renderHistory() {
            const historyTable = document.getElementById('history-tbody');
            historyTable.innerHTML = '';
            
            if (appData.history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align: center; color: #777;">履歴なし</td>';
                historyTable.appendChild(row);
                return;
            }
            
            // 日付の新しい順にソート
            const sortedHistory = [...appData.history].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            sortedHistory.forEach((record, index) => {
                const row = document.createElement('tr');
                const date = new Date(record.date);
                const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                
                // 次回学習日の計算
                let nextReviewText = '-';
                if (record.nextReview) {
                    const nextDate = new Date(record.nextReview);
                    nextReviewText = `${nextDate.getMonth() + 1}/${nextDate.getDate()}`;
                    
                    // 今日の日付との比較
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (nextDate < today) {
                        nextReviewText = `<span class="next-review">期限切れ (${nextReviewText})</span>`;
                    } else if (
                        nextDate.getDate() === today.getDate() && 
                        nextDate.getMonth() === today.getMonth() && 
                        nextDate.getFullYear() === today.getFullYear()
                    ) {
                        nextReviewText = `<span class="next-review">今日 (${nextReviewText})</span>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><span class="category cat-${record.category}">${getCategoryLabel(record.category)}</span> ${record.itemName}</td>
                    <td>${nextReviewText}</td>
                    <td><button class="btn-small btn-delete" onclick="deleteHistoryItem(${index})">削除</button></td>
                `;
                historyTable.appendChild(row);
            });
        }
        
        // 履歴項目を削除
        function deleteHistoryItem(index) {
            if (confirm('この学習記録を削除してもよろしいですか？')) {
                // 配列からインデックスの要素を削除
                const sortedHistory = [...appData.history].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                const recordToDelete = sortedHistory[index];
                
                // 元の配列から削除するために元のインデックスを探す
                const originalIndex = appData.history.findIndex(record => 
                    record.date === recordToDelete.date && 
                    record.itemName === recordToDelete.itemName &&
                    record.category === recordToDelete.category
                );
                
                if (originalIndex !== -1) {
                    appData.history.splice(originalIndex, 1);
                    renderHistory();
                    saveData();
                    showNotification('学習記録を削除しました');
                }
            }
        }
        
        // 学習項目のセレクトボックスを更新
        function updateItems() {
            const category = document.getElementById('study-category').value;
            const itemSelect = document.getElementById('study-item');
            const itemSelection = document.getElementById('item-selection');
            const otherItem = document.getElementById('other-item');
            
            if (category === 'other') {
                itemSelection.style.display = 'none';
                otherItem.style.display = 'block';
            } else {
                itemSelection.style.display = 'block';
                otherItem.style.display = 'none';
                itemSelect.innerHTML = '';
                
                if (studyItems[category]) {
                    studyItems[category].forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        itemSelect.appendChild(option);
                    });
                }
            }
        }
        
        // タブの切り替え
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }
        
        // タスクの完了/未完了を切り替え
        function toggleTask(index) {
            appData.tasks[index].completed = !appData.tasks[index].completed;
            renderTasks();
            saveData();
        }
        
        // 新しいタスクを追加
        function addTask() {
            const taskName = prompt('タスク名を入力してください:');
            if (!taskName) return;
            
            const categories = ['planning', 'environment', 'law', 'structure', 'construction', 'other'];
            const defaultCategory = 'planning';
            
            let categoryPrompt = '以下からカテゴリを選択してください（番号を入力）:\n';
            categories.forEach((cat, idx) => {
                categoryPrompt += `${idx + 1}: ${getCategoryLabel(cat)}\n`;
            });
            
            const categoryInput = prompt(categoryPrompt, '1');
            let taskCategory = defaultCategory;
            
            if (categoryInput && !isNaN(parseInt(categoryInput))) {
                const idx = parseInt(categoryInput) - 1;
                if (idx >= 0 && idx < categories.length) {
                    taskCategory = categories[idx];
                }
            }
            
            appData.tasks.push({
                name: taskName,
                category: taskCategory,
                completed: false
            });
            
            renderTasks();
            saveData();
        }
        
        // カテゴリのラベルを取得
        function getCategoryLabel(category) {
            const labels = {
                'planning': '計画',
                'environment': '環境',
                'law': '法規',
                'structure': '構造',
                'construction': '施工',
                'other': 'その他'
            };
            return labels[category] || '計画';
        }
        
        // 次回学習日を計算
        function calculateNextReviewDate(studyDate) {
            const date = new Date(studyDate);
            const pattern = appData.settings.reviewPattern;
            
            // 復習パターンの最初の間隔を日数に追加
            if (pattern && pattern.length > 0) {
                date.setDate(date.getDate() + pattern[0]);
            } else {
                // デフォルトは2日後
                date.setDate(date.getDate() + 2);
            }
            return date;
        }
        
        // 学習記録を保存
        function recordStudy() {
            const date = document.getElementById('study-date').value;
            if (!date) {
                alert('日付を選択してください');
                return;
            }
            
            const category = document.getElementById('study-category').value;
            let itemId = '';
            let itemName = '';
            
            if (category === 'other') {
                itemName = document.getElementById('other-item-input').value;
                if (!itemName) {
                    alert('項目名を入力してください');
                    return;
                }
            } else {
                const itemSelect = document.getElementById('study-item');
                itemId = itemSelect.value;
                itemName = itemSelect.options[itemSelect.selectedIndex].text;
            }
            
            // 次回学習日を計算
            const nextReview = calculateNextReviewDate(date);
            
            // 学習履歴に追加
            appData.history.push({
                date,
                category,
                itemId,
                itemName,
                nextReview: nextReview.toISOString()
            });
            
            renderHistory();
            saveData();
            
            // フォームをリセット
            if (category === 'other') {
                document.getElementById('other-item-input').value = '';
            }
        }
        
        // 設定を保存
        function saveSettings() {
            appData.settings.examDate = document.getElementById('exam-date').value;
            
            // 復習パターンの設定
            const patternInput = document.getElementById('review-pattern').value;
            if (patternInput) {
                try {
                    const pattern = patternInput.split(',').map(s => parseInt(s.trim()));
                    if (pattern.length > 0 && !pattern.some(isNaN)) {
                        appData.settings.reviewPattern = pattern;
                    }
                } catch (e) {
                    console.error('Invalid review pattern:', e);
                }
            }
            
            saveData();
        }
        
        // データエクスポート
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "architect_study_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // データインポート
        function importData() {
            if (confirm('データをインポートすると現在のデータが上書きされます。よろしいですか？')) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            appData = importedData;
                            saveData();
                            location.reload();
                        } catch (error) {
                            alert('データの読み込みに失敗しました: ' + error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }
        
        // データクリア
        function clearData() {
            if (confirm('すべてのデータを削除します。この操作は元に戻せません。よろしいですか？')) {
                localStorage.removeItem('architect_study_data');
                appData = {
                    tasks: [],
                    history: [],
                    settings: { 
                        examDate: '2025-07-27',
                        reviewPattern: [2, 7, 16, 35, 62]
                    }
                };
                renderTasks();
                renderHistory();
                showNotification('データを削除しました');
            }
        }
    </script>
</body>
</html>
